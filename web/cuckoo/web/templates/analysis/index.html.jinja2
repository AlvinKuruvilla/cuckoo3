{% extends "base.html.jinja2" %}
{% set active_page = "analyses" %}
{% set report_page = "sample" %}
{% set title = "Analysis" %}

{% from 'macros.html.jinja2' import ui_box, color_class, color_text, render_dict %}

{% block page_script %}
  <script src="{{ static('js/report.task.js') }}"></script>
{% endblock %}

{% block body %}
  <div class="container is-fixed">
    <div class="columns is-divided is-vtop">
      <aside class="column is-auto has-padding is-sticky">
        {% include "analysis/partial/sidebar.html.jinja2" %}
      </aside>
      <section class="column has-padding">

        <h2>Analysis</h2>
        <p>Description and overview of target and submission configuration.</p>

        {#
          {% call ui_box(title="Data") %}
            <p>analysis</p>
            {{ render_dict(analysis) }}
            <p>pre</p>
            {{ render_dict(pre) }}
          {% endcall %}
        #}

        {% call ui_box(title="Target") %}
          <div class="columns has-padding is-divided">
            <div class="column is-auto">
              <div class="ratio-1-1">
                <div class="ratio-content">
                  <p class="{{ color_text(analysis.score) }} has-text-huge no-margin"><strong>{{ analysis.score }}</strong><sub class="has-text-light">/10</sub></p>
                </div>
                <div class="ratio-content is-bottom has-text-small has-half-opacity">Analysis score</div>
              </div>
            </div>
            <div class="column">
              <h3 class="no-margin-bottom is-monospace">
                <strong>{{ analysis.id }}</strong>
                <span class="pull-right has-half-opacity">{{ analysis.state|humanstate }}</span>
              </h3>
              <p class="has-line-break has-text-small">
                <span class="icon">
                  <i class="far fa-file"></i>
                </span> {{ analysis.target.filename }}
              </p>
              <ul class="list is-horizontal no-margin-bottom has-text-small">
                <li title="Date of creation">
                  <span class="icon">
                    <i class="far fa-calendar"></i>
                  </span> {{ analysis.created_on | formatdatetime }}
                </li>
                <li>
                  <span class="icon">
                    <i class="fas fa-compact-disc"></i>
                  </span> {{ analysis.target.size | filesizeformat }}
                </li>
                <li class="is-monospace">
                  <span class="icon">
                    <i class="fas fa-terminal"></i>
                  </span> {{ analysis.target.media_type }}
                </li>
              </ul>
            </div>
          </div>
        {% endcall %}

        {% call ui_box(title="Signatures", has_padding=False) %}
          <table class="table">
            <thead>
              <tr>
                <th>&nbsp;</th>
                <th>Detected signatures</th>
                <th>Events</th>
                <th>&nbsp;</th>
              </tr>
            </thead>
            <tbody>
              {% for signature in pre.signatures %}
                <tr data-row="{{ loop.index }}">
                  <td><span class="tag {{ color_class(signature.score) }}">{{ signature.score }}</span></td>
                  <td>{{ signature.short_description }}</td>
                  <td>{{ signature.description }}</td>
                  <td class="no-text-wrap">
                    <a class="is-link has-text-small toggle-ioc" href="#">Display IOC's</a>
                  </td>
                </tr>
                <tr hidden data-row-of="{{ loop.index }}">
                  <td colspan="4" class="no-padding has-border-y">
                    <table class="table">
                      <tbody>
                        {% for ioc in signature.iocs %}
                          <tr>
                            {% for k, v in ioc.items() %}
                              <td><strong class="has-text-capitalized">{{ k }}</strong></td>
                              <td>{{ v }}</td>
                            {% endfor %}
                          </tr>
                        {% endfor %}
                        <tr class="separator-bar">
                          <td colspan="4">&nbsp;</td>
                        </tr>
                      </tbody>
                    </table>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endcall %}

        {% call ui_box(title="Target summary", has_padding=False) %}
          <div class="tabbar" data-enhance>
            <a href="#file-analysis" class="tabbar-link is-active">Target</a>
            <a href="#submission" class="tabbar-link">Submission</a>
            <a href="#settings" class="tabbar-link">Settings</a>
          </div>

          <table class="table" id="submission" hidden>
            <thead>
              <tr>
                <th>Property</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="no-line-break"><strong>Category</strong></td>
                <td class="has-line-break">{{ analysis.submitted.category }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>File name</strong></td>
                <td class="has-line-break">{{ analysis.submitted.filename }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>Size</strong></td>
                <td class="has-line-break">{{ analysis.submitted.size | filesizeformat }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>Type</strong></td>
                <td class="has-line-break">{{ analysis.submitted.type }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>Media Type</strong></td>
                <td class="has-line-break">{{ analysis.submitted.media_type }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>MD5</strong></td>
                <td class="has-line-break">{{ analysis.submitted.md5 }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>SHA1</strong></td>
                <td class="has-line-break">{{ analysis.submitted.sha1 }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>SHA256</strong></td>
                <td class="has-line-break">{{ analysis.submitted.sha256 }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>SHA512</strong></td>
                <td class="has-line-break">{{ analysis.submitted.sha512 }}</td>
              </tr>
            </tbody>
          </table>
          <table class="table" id="settings" hidden>
            <thead>
              <tr>
                <th>Property</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="no-line-break"><strong>Timeout</strong></td>
                <td class="has-line-break">{{ analysis.settings.timeout }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>Priority</strong></td>
                <td class="has-line-break">{{ analysis.settings.priority }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>Platforms</strong></td>
                <td class="has-line-break">
                  {# analysis.settings.platforms #}
                  {% if analysis.settings.platforms|length %}
                    {% for p in analysis.settings.platforms %}
                      <div class="tag-list no-margin-y">
                        <code class="no-margin-y has-margin-right">{{ p.platform }} {{ p.os_version }}</code>
                        {% if p.tags|length > 0 %}
                          {% for t in p.tags %}
                            <div class="tag no-margin-y has-margin-bottom">{{ t }}</div>
                          {% endfor %}
                        {% endif %}
                      </div>
                    {% endfor %}
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
          <table class="table" id="file-analysis">
            <thead>
              <tr>
                <th>Property</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="no-line-break"><strong>File name</strong></td>
                <td class="has-line-break">{{ analysis.target.filename }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>Size</strong></td>
                <td class="has-line-break">{{ analysis.target.size | filesizeformat }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>Type</strong></td>
                <td class="has-line-break">{{ analysis.target.filetype }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>Media Type</strong></td>
                <td class="has-line-break">{{ analysis.target.media_type }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>MD5</strong></td>
                <td class="has-line-break">{{ analysis.target.md5 }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>SHA1</strong></td>
                <td class="has-line-break">{{ analysis.target.sha1 }}</td>
              </tr>
              <tr>
                <td class="no-line-break"><strong>SHA256</strong></td>
                <td class="has-line-break">{{ analysis.target.sha256 }}</td>
              </tr>
            </tbody>
          </table>
        {% endcall %}

        <script>
          window.analysis = "{{ analysis.tasks | safe }}";
        </script>

      </section>
    </div>
  </div>
{% endblock %}
